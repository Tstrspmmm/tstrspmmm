<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scale Reader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #1a202c, #2d3748);
      min-height: 100vh;
    }
    .frosted {
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body class="text-white font-sans">
  <div class="container mx-auto p-6 max-w-lg relative z-10">
    <h1 class="text-4xl font-bold text-center mb-4 text-white">Scale Reader</h1>
    <p class="text-center text-gray-300 mb-6 text-lg">Align your scaleâ€™s digits within the red box.</p>

    <div class="mb-6 relative frosted rounded-xl p-4 shadow-lg">
      <video id="video" class="w-full rounded-lg" autoplay playsinline></video>
      <canvas id="overlay" class="absolute top-4 left-4 w-[calc(100%-2rem)] h-[calc(100%-2rem)] pointer-events-none"></canvas>
      <canvas id="canvas" class="hidden"></canvas>
    </div>

    <div class="flex flex-wrap justify-center gap-4 mb-6">
      <button id="startBtn" class="frosted px-4 py-2 rounded-lg text-white hover:bg-opacity-80 transition">Start Camera</button>
      <button id="captureBtn" class="frosted px-4 py-2 rounded-lg text-white hover:bg-opacity-80 transition hidden">Manual Capture</button>
      <button id="showImageBtn" class="frosted px-4 py-2 rounded-lg text-white hover:bg-opacity-80 transition hidden">Show Preprocessed</button>
      <button id="toggleLogGraph" class="frosted px-4 py-2 rounded-lg text-white hover:bg-opacity-80 transition">Show Graph</button>
    </div>

    <div id="preprocessedImage" class="mb-6 hidden transition-opacity duration-300">
      <img id="processedImg" class="w-full rounded-xl shadow-lg" alt="Preprocessed Image">
    </div>

    <div id="currentReading" class="text-center text-2xl font-semibold mb-4 frosted p-4 rounded-xl">
      Weight: <span id="weight">0</span> g
    </div>

    <div id="pourRate" class="text-center text-xl text-gray-300 mb-4">
      Pour Rate: <span id="rate">0</span> g/s
    </div>

    <div id="debug" class="text-center text-base text-gray-400 mb-4 frosted p-4 rounded-xl">
      Debug: <span id="debugText">Waiting for capture...</span>
    </div>

    <div id="logContainer" class="frosted p-4 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold mb-2 text-blue-300">Weight Log</h2>
      <ul id="logList" class="text-base text-gray-300 max-h-48 overflow-y-auto"></ul>
    </div>

    <div id="graphContainer" class="hidden frosted p-4 rounded-xl shadow-lg">
      <canvas id="weightChart" class="w-full h-64"></canvas>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const overlayCtx = overlay.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const showImageBtn = document.getElementById('showImageBtn');
    const toggleLogGraph = document.getElementById('toggleLogGraph');
    const processedImg = document.getElementById('processedImg');
    const preprocessedImage = document.getElementById('preprocessedImage');
    const weightDisplay = document.getElementById('weight');
    const rateDisplay = document.getElementById('rate');
    const debugText = document.getElementById('debugText');
    const logList = document.getElementById('logList');
    const logContainer = document.getElementById('logContainer');
    const graphContainer = document.getElementById('graphContainer');

    let stream = null;
    let lastWeight = 0;
    let lastTime = Date.now();
    let readings = JSON.parse(localStorage.getItem('scaleReadings')) || [];
    let autoCaptureInterval = null;
    let isGraphMode = false;

    // Define 7-segment digit templates (15 rows x 10 cols)
    const segments = {
      top: { rows: [0,1], cols: [2,7] },
      leftTop: { rows: [2,7], cols: [0,1] },
      rightTop: { rows: [2,7], cols: [8,9] },
      middle: { rows: [7,8], cols: [2,7] },
      leftBottom: { rows: [8,13], cols: [0,1] },
      rightBottom: { rows: [8,13], cols: [8,9] },
      bottom: { rows: [13,14], cols: [2,7] }
    };

    const digitSegments = {
      '0': ['top', 'leftTop', 'leftBottom', 'rightTop', 'rightBottom', 'bottom'],
      '1': ['rightTop', 'rightBottom'],
      '2': ['top', 'rightTop', 'middle', 'leftBottom', 'bottom'],
      '3': ['top', 'rightTop', 'middle', 'rightBottom', 'bottom'],
      '4': ['leftTop', 'rightTop', 'middle', 'rightBottom'],
      '5': ['top', 'leftTop', 'middle', 'rightBottom', 'bottom'],
      '6': ['top', 'leftTop', 'leftBottom', 'middle', 'rightBottom', 'bottom'],
      '7': ['top', 'rightTop', 'rightBottom'],
      '8': ['top', 'leftTop', 'leftBottom', 'middle', 'rightTop', 'rightBottom', 'bottom'],
      '9': ['top', 'leftTop', 'rightTop', 'middle', 'rightBottom', 'bottom']
    };

    const templates = {};
    for (let d = 0; d <= 9; d++) {
      templates[d] = new Array(15 * 10).fill(0);
      const segList = digitSegments[String(d)];
      segList.forEach(seg => {
        const { rows, cols } = segments[seg];
        for (let y = rows[0]; y <= rows[1]; y++) {
          for (let x = cols[0]; x <= cols[1]; x++) {
            templates[d][y * 10 + x] = 1;
          }
        }
      });
    }

    // Initialize Chart.js
    const chartCtx = document.getElementById('weightChart').getContext('2d');
    const weightChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Weight (g)',
          data: [],
          borderColor: 'rgba(59, 130, 246, 1)',
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          fill: true,
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'second',
              displayFormats: { second: 'HH:mm:ss' }
            },
            ticks: { source: 'auto', autoSkip: true, maxTicksLimit: 10 }
          },
          y: { beginAtZero: true }
        },
        plugins: { legend: { display: false } }
      }
    });

    // Event Listeners
    startBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', captureImage);
    showImageBtn.addEventListener('click', () => {
      preprocessedImage.classList.toggle('hidden');
    });
    toggleLogGraph.addEventListener('click', () => {
      isGraphMode = !isGraphMode;
      if (isGraphMode) {
        logContainer.classList.add('hidden');
        graphContainer.classList.remove('hidden');
        toggleLogGraph.textContent = 'Show Log';
      } else {
        logContainer.classList.remove
